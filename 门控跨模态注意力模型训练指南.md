# 门控跨模态注意力模型训练指南

本指南详细介绍如何训练使用门控跨模态注意力机制的DeepBindNet模型，包括环境准备、数据处理、模型训练、性能评估和结果分析。

## 目录

- [门控跨模态注意力模型训练指南](#门控跨模态注意力模型训练指南)
  - [目录](#目录)
  - [环境准备](#环境准备)
  - [数据准备](#数据准备)
  - [模型训练](#模型训练)
    - [基本训练](#基本训练)
    - [高级训练参数](#高级训练参数)
    - [训练监控](#训练监控)
  - [模型评估](#模型评估)
  - [结果分析](#结果分析)
  - [常见问题](#常见问题)
    - [Q: 训练时内存不足怎么办？](#q-训练时内存不足怎么办)
    - [Q: 模型过拟合怎么处理？](#q-模型过拟合怎么处理)
    - [Q: 训练速度太慢怎么优化？](#q-训练速度太慢怎么优化)
    - [Q: 如何调整门控机制的行为？](#q-如何调整门控机制的行为)
    - [Q: 验证性能好但测试性能差怎么解决？](#q-验证性能好但测试性能差怎么解决)

## 环境准备

首先确保您的环境中已安装以下依赖：

```bash
# 安装基础依赖
pip install torch==1.10.0 torch-geometric==2.0.4 numpy==1.21.4 matplotlib==3.5.1 scikit-learn==1.0.1 tensorboard==2.7.0
```

对于GPU训练（推荐）：
```bash
# 确保CUDA版本与PyTorch兼容
nvidia-smi  # 检查CUDA版本
```

## 数据准备

训练前需要确保数据已经过预处理：

1. 确认数据目录结构：
```
data/
└── processed/
    ├── train_data.pkl
    ├── val_data.pkl
    ├── test_data.pkl
    └── scaler_params.pkl
```

2. 如果需要重新处理数据：

```bash
python preprocess.py --input_file data/KIBA.csv --output_dir data/processed --test_size 0.2 --val_size 0.1
```

## 模型训练

### 基本训练

使用以下命令启动门控模型的基本训练：

```bash
python train_gated.py --output_dir outputs_gated
```

这将使用默认参数训练门控跨模态注意力模型，并将结果保存到`outputs_gated`目录。

### 高级训练参数

根据您的需求调整以下参数：

```bash
python train_gated.py \
  --output_dir outputs_gated \
  --data_dir data/processed \
  --hidden_dim 256 \
  --feature_dim 512 \
  --fusion_heads 8 \
  --fusion_layers 4 \
  --dropout_rate 0.1 \
  --batch_size 128 \
  --num_epochs 200 \
  --lr 1e-4 \
  --weight_decay 0.001 \
  --patience 15 \
  --mixed_precision
```

参数说明：
- `--output_dir`：模型输出目录
- `--data_dir`：预处理数据目录
- `--hidden_dim`：隐藏层维度
- `--feature_dim`：特征维度
- `--fusion_heads`：融合模块注意力头数
- `--fusion_layers`：融合模块层数
- `--dropout_rate`：Dropout比率
- `--batch_size`：批次大小
- `--num_epochs`：训练轮数
- `--lr`：初始学习率
- `--weight_decay`：权重衰减
- `--patience`：早停耐心值
- `--mixed_precision`：使用混合精度训练（加速训练）

### 训练监控

训练过程中，您可以通过以下方式监控进度：

1. **终端输出**：显示每个批次和轮次的损失和指标
2. **TensorBoard**：实时查看训练曲线

   ```bash
   tensorboard --logdir outputs_gated/logs
   ```

训练将自动保存以下检查点：
- `latest_checkpoint.pt`：最新模型
- `best_model.pt`：验证集上表现最佳的模型
- `checkpoint_epoch_X.pt`：每隔5轮保存一次

## 模型评估

训练完成后，使用以下命令评估模型性能：

```bash
# 比较标准模型和门控模型的性能
python compare_trained_models.py \
  --standard_model_dir outputs \
  --gated_model_dir outputs_gated \
  --output_dir comparison_results
```

这将生成以下比较图表：
- 预测值与真实值散点图
- 误差分布直方图
- 性能指标比较条形图
- 性能改进百分比图

## 结果分析

评估结果将显示门控模型相对于标准模型的改进，主要关注以下指标：

1. **RMSE**（均方根误差）：越低越好
2. **MAE**（平均绝对误差）：越低越好
3. **R²**（决定系数）：越接近1越好

门控机制的优势通常体现在：
- 噪声数据下的预测稳定性提高
- 对异常样本的鲁棒性增强
- 整体预测精度的提升

## 常见问题

### Q: 训练时内存不足怎么办？
A: 尝试减小批次大小（`--batch_size`）或使用混合精度训练（`--mixed_precision`）。

### Q: 模型过拟合怎么处理？
A: 增加权重衰减（`--weight_decay`）或Dropout比率（`--dropout_rate`），也可以减少模型复杂度（降低`--feature_dim`或`--fusion_layers`）。

### Q: 训练速度太慢怎么优化？
A: 使用GPU训练，启用混合精度（`--mixed_precision`），增加批次大小，或减少模型复杂度。

### Q: 如何调整门控机制的行为？
A: 门控机制的行为主要由训练数据决定，但您可以通过修改`fusion.py`中的`GatedCrossAttention`类来调整门控网络的结构和初始化方式。

### Q: 验证性能好但测试性能差怎么解决？
A: 这通常是过拟合的迹象。尝试使用更强的正则化，或收集更多样本进行训练。

---

如有任何问题或需要进一步的帮助，请参考项目文档或联系项目维护者。
